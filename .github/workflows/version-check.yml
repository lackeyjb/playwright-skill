name: Version Check

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  check-version-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          echo "Checking version consistency across all manifest files..."

          # Extract versions from all files
          PLUGIN_VERSION=$(grep '"version"' .claude-plugin/plugin.json | head -1 | sed 's/.*"version": "\([^"]*\)".*/\1/')
          MARKETPLACE_VERSION=$(python3 -c "import json; print(json.load(open('.claude-plugin/marketplace.json'))['plugins'][0]['version'])")
          PYPROJECT_VERSION=$(grep '^version = ' skills/playwright-skill/pyproject.toml | sed 's/version = "\([^"]*\)"/\1/')

          echo "plugin.json version: $PLUGIN_VERSION"
          echo "marketplace.json version: $MARKETPLACE_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"

          # Check all versions match
          if [[ "$PLUGIN_VERSION" != "$MARKETPLACE_VERSION" ]]; then
            echo ""
            echo "❌ Version mismatch!"
            echo "   plugin.json: $PLUGIN_VERSION"
            echo "   marketplace.json: $MARKETPLACE_VERSION"
            echo ""
            echo "Run './scripts/bump-version.sh <version>' to sync versions"
            exit 1
          fi

          if [[ "$PLUGIN_VERSION" != "$PYPROJECT_VERSION" ]]; then
            echo ""
            echo "❌ Version mismatch!"
            echo "   plugin.json: $PLUGIN_VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo ""
            echo "Run './scripts/bump-version.sh <version>' to sync versions"
            exit 1
          fi

          echo ""
          echo "✅ All versions synchronized: $PLUGIN_VERSION"

      - name: Validate version format
        run: |
          VERSION=$(grep '"version"' .claude-plugin/plugin.json | head -1 | sed 's/.*"version": "\([^"]*\)".*/\1/')

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version format: $VERSION"
            echo "   Expected semantic versioning: X.Y.Z"
            exit 1
          fi

          echo "✅ Version format valid: $VERSION"
